# Data Model: RAG Chatbot

This document details the database schemas for the RAG Chatbot, including PostgreSQL tables for chat sessions, messages, and agent memory, and the Qdrant collection schema for book content.

## 1. PostgreSQL Database Schema (Neon Serverless Postgres)

**Database**: Neon Serverless Postgres
**Tool**: Psycopg2 (Python client) or SQLAlchemy ORM

### Table: `chat_sessions`

Stores information about each user conversation session.

| Column        | Type     | Constraints           | Description                                    |
| :------------ | :------- | :-------------------- | :--------------------------------------------- |
| `id`          | UUID     | PRIMARY KEY, NOT NULL | Unique identifier for the chat session.        |
| `user_id`     | TEXT     | NOT NULL              | Identifier for the user (can be anonymous).    |
| `created_at`  | TIMESTAMP| NOT NULL, DEFAULT NOW() | Timestamp when the session was created.        |
| `agent_state` | JSONB    | NULLABLE              | Stores the serializable state of the OpenAI agent for multi-turn conversations. |

### Table: `messages`

Stores individual messages exchanged within a chat session.

| Column       | Type      | Constraints                     | Description                                    |
| :----------- | :-------- | :------------------------------ | :--------------------------------------------- |
| `id`         | UUID      | PRIMARY KEY, NOT NULL           | Unique identifier for the message.             |
| `session_id` | UUID      | NOT NULL, FOREIGN KEY (chat_sessions.id) | Links to the parent chat session.              |
| `role`       | TEXT      | NOT NULL                        | Role of the message sender (user, assistant, system, tool). |
| `content`    | TEXT      | NOT NULL                        | The message text.                              |
| `timestamp`  | TIMESTAMP | NOT NULL, DEFAULT NOW()         | Timestamp when the message was created.        |
| `tool_calls` | JSONB     | NULLABLE                        | Stores details if the message involved agent tool calls. |

### Table: `agent_memory` (Optional, for more complex memory management)

Can be used for long-term agent memory or contextual data beyond session state.

| Column       | Type      | Constraints                     | Description                                    |
| :----------- | :-------- | :------------------------------ | :--------------------------------------------- |
| `session_id` | UUID      | PRIMARY KEY, NOT NULL, FOREIGN KEY (chat_sessions.id) | Links to the chat session.                 |
| `context_data`| JSONB     | NOT NULL                        | Stores long-term contextual data for the agent. |
| `last_updated`| TIMESTAMP | NOT NULL, DEFAULT NOW()         | Timestamp of the last update.                  |

## 2. Qdrant Vector Database Schema

**Vector DB**: Qdrant Cloud
**Collection Name**: `book_content`

This collection stores vector embeddings of chunks from the Physical AI & Humanoid Robotics book content, along with associated metadata.

### Collection Structure: `book_content`

| Component   | Type                          | Description                                    |
| :---------- | :---------------------------- | :--------------------------------------------- |
| `vectors`   | FLOAT_VECTOR (1536 dimensions)| Vector embedding of the `text` field, generated by OpenAI `text-embedding-3-small`. |
| `payload`   | JSON Object                   | Stores metadata associated with each vector.   |

### `payload` fields:

| Field          | Type     | Description                                                          |
| :------------- | :------- | :------------------------------------------------------------------- |
| `text`         | TEXT     | The original text chunk from the book content that was embedded.     |
| `module`       | TEXT     | The module name (e.g., "Module 1: ROS 2 Fundamentals").              |
| `page`         | TEXT     | The page name within the module (e.g., "intro.md", "concepts.md").   |
| `title`        | TEXT     | The title of the section or page from which the chunk originated.    |
| `code_blocks`  | JSONB (Array of TEXT) | Optional: Any code blocks present within the text chunk, stored as an array of strings. |

---
**Note on `agent_state` and `context_data`**:
The `agent_state` in `chat_sessions` is intended for the OpenAI Agent's internal, serializable state, crucial for multi-turn conversations. `agent_memory` is a more generic table that could be used for broader, longer-term contextual information or explicit memory augmentation for the agent, beyond just its conversational state. The specific usage will depend on the OpenAI Agents SDK's capabilities and how deeply state needs to be managed externally.
